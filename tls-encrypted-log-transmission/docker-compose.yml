services:
  cert-gen:
    build: .
    container_name: tls_cert_gen
    entrypoint: ["sh", "-c", "cp /app/certs/ca.crt /shared-certs/ca.crt && echo 'CA cert copied to shared volume'"]
    volumes:
      - shared-certs:/shared-certs

  tls-server:
    build: .
    container_name: tls_log_server
    ports:
      - "8443:8443"
      - "8081:8080"
    environment:
      - SERVER_HOST=0.0.0.0
      - SERVER_PORT=8443
      - CERT_FILE=/app/certs/server.crt
      - KEY_FILE=/app/certs/server.key
      - LOG_DIR=/app/logs
      - MAX_LOGS_PER_FILE=10
    healthcheck:
      test: ["CMD", "python", "healthcheck.py"]
      interval: 10s
      timeout: 5s
      start_period: 5s
      retries: 3
    depends_on:
      cert-gen:
        condition: service_completed_successfully
    volumes:
      - shared-certs:/shared-certs

  tls-client:
    build:
      context: .
      dockerfile: Dockerfile.client
    environment:
      - SERVER_HOST=tls-server
      - SERVER_PORT=8443
    depends_on:
      tls-server:
        condition: service_healthy
    profiles:
      - client

  healthcare-client:
    build:
      context: .
      dockerfile: Dockerfile.client
    command: ["python", "-u", "client_main.py", "--healthcare"]
    environment:
      - SERVER_HOST=tls-server
      - SERVER_PORT=8443
    depends_on:
      tls-server:
        condition: service_healthy
    profiles:
      - healthcare

  verified-client:
    build:
      context: .
      dockerfile: Dockerfile.client
    environment:
      - SERVER_HOST=tls-server
      - SERVER_PORT=8443
      - VERIFY_CERTS=true
      - CA_FILE=/shared-certs/ca.crt
    depends_on:
      tls-server:
        condition: service_healthy
    volumes:
      - shared-certs:/shared-certs
    profiles:
      - verified

  tests:
    build:
      context: .
      dockerfile: Dockerfile.test
    profiles:
      - test

volumes:
  shared-certs:
