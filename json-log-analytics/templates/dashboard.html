<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON Log Analytics Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #1a1a2e;
            color: #e0e0e0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px 0;
            border-bottom: 1px solid #2a2a4a;
        }

        .header h1 {
            font-size: 2rem;
            color: #ffffff;
            margin-bottom: 5px;
        }

        .header .subtitle {
            font-size: 0.9rem;
            color: #888;
        }

        /* Stats Cards Row */
        .stats-row {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            flex: 1;
            background: #16213e;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            border-top: 3px solid;
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        .stat-card .stat-value {
            font-size: 2.2rem;
            font-weight: 700;
            margin: 10px 0 5px;
        }

        .stat-card .stat-label {
            font-size: 0.85rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-card.blue { border-top-color: #4a9eff; }
        .stat-card.blue .stat-value { color: #4a9eff; }

        .stat-card.green { border-top-color: #2ecc71; }
        .stat-card.green .stat-value { color: #2ecc71; }

        .stat-card.red { border-top-color: #ff4a4a; }
        .stat-card.red .stat-value { color: #ff4a4a; }

        .stat-card.purple { border-top-color: #9b59b6; }
        .stat-card.purple .stat-value { color: #9b59b6; }

        .stat-card.gray { border-top-color: #6c757d; }
        .stat-card.gray .stat-value { color: #6c757d; }

        /* Charts Section */
        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: #16213e;
            border-radius: 10px;
            padding: 20px;
        }

        .chart-card h3 {
            margin-bottom: 15px;
            color: #ffffff;
            font-size: 1.1rem;
        }

        .chart-card canvas {
            max-height: 300px;
        }

        /* Section Headers */
        .section-header {
            font-size: 1.3rem;
            color: #ffffff;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid #2a2a4a;
        }

        /* Active Alerts Panel */
        .alerts-panel {
            margin-bottom: 30px;
        }

        .alert-card {
            background: #16213e;
            border-radius: 8px;
            padding: 15px 20px;
            margin-bottom: 10px;
            border-left: 4px solid;
        }

        .alert-card.critical {
            background: #ff4a4a20;
            border-left-color: #ff4a4a;
        }

        .alert-card.warning {
            background: #f39c1220;
            border-left-color: #f39c12;
        }

        .alert-card .alert-rule {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 4px;
        }

        .alert-card .alert-message {
            font-size: 0.9rem;
            color: #ccc;
            margin-bottom: 6px;
        }

        .alert-card .alert-meta {
            font-size: 0.8rem;
            color: #888;
        }

        .alert-card .alert-meta span {
            margin-right: 15px;
        }

        .no-alerts {
            background: #16213e;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            color: #2ecc71;
            font-size: 1rem;
        }

        /* Service Health Grid */
        .service-health {
            margin-bottom: 30px;
        }

        .service-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .service-card {
            background: #16213e;
            border-radius: 8px;
            padding: 15px;
        }

        .service-card .service-name {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            flex-shrink: 0;
        }

        .status-dot.healthy { background: #2ecc71; }
        .status-dot.warning { background: #f39c12; }
        .status-dot.down { background: #ff4a4a; }

        .service-card .service-detail {
            font-size: 0.85rem;
            color: #888;
            margin-bottom: 3px;
        }

        /* Recent Logs Table */
        .logs-section {
            margin-bottom: 30px;
        }

        .logs-table-wrapper {
            max-height: 400px;
            overflow-y: auto;
            border-radius: 8px;
            background: #16213e;
        }

        .logs-table-wrapper::-webkit-scrollbar {
            width: 8px;
        }

        .logs-table-wrapper::-webkit-scrollbar-track {
            background: #16213e;
        }

        .logs-table-wrapper::-webkit-scrollbar-thumb {
            background: #2a2a4a;
            border-radius: 4px;
        }

        .logs-table {
            width: 100%;
            border-collapse: collapse;
        }

        .logs-table thead {
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .logs-table th {
            background: #0f3460;
            padding: 12px 15px;
            text-align: left;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #aaa;
        }

        .logs-table td {
            padding: 10px 15px;
            border-bottom: 1px solid #1a1a3e;
            font-size: 0.9rem;
        }

        .logs-table tr:hover {
            background: #1e2a4a;
        }

        .logs-table .msg-col {
            max-width: 500px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .level-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .level-badge.debug { background: #6c757d33; color: #6c757d; }
        .level-badge.info { background: #4a9eff33; color: #4a9eff; }
        .level-badge.warning { background: #f39c1233; color: #f39c12; }
        .level-badge.error { background: #e74c3c33; color: #e74c3c; }
        .level-badge.critical { background: #c0392b33; color: #c0392b; }

        /* Responsive */
        @media (max-width: 900px) {
            .stats-row {
                flex-wrap: wrap;
            }
            .stat-card {
                flex: 1 1 calc(50% - 10px);
            }
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 600px) {
            .stat-card {
                flex: 1 1 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>JSON Log Analytics Dashboard</h1>
            <div class="subtitle">Last refresh: <span id="last-refresh">--:--:--</span></div>
        </div>

        <!-- Stats Cards Row -->
        <div class="stats-row">
            <div class="stat-card blue" id="card-total-logs">
                <div class="stat-label">Total Logs</div>
                <div class="stat-value" id="total-logs">0</div>
            </div>
            <div class="stat-card green" id="card-error-rate">
                <div class="stat-label">Error Rate</div>
                <div class="stat-value" id="error-rate">0%</div>
            </div>
            <div class="stat-card purple" id="card-services">
                <div class="stat-label">Services Tracked</div>
                <div class="stat-value" id="services-tracked">0</div>
            </div>
            <div class="stat-card gray" id="card-alerts">
                <div class="stat-label">Active Alerts</div>
                <div class="stat-value" id="active-alerts">0</div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="charts-grid">
            <div class="chart-card">
                <h3>Log Volume Over Time</h3>
                <canvas id="volume-chart"></canvas>
            </div>
            <div class="chart-card">
                <h3>Error Rate Over Time</h3>
                <canvas id="error-chart"></canvas>
            </div>
        </div>

        <!-- Active Alerts Panel -->
        <div class="alerts-panel">
            <h2 class="section-header">Active Alerts</h2>
            <div id="alerts-container">
                <div class="no-alerts">No active alerts</div>
            </div>
        </div>

        <!-- Service Health Grid -->
        <div class="service-health">
            <h2 class="section-header">Service Health</h2>
            <div class="service-grid" id="service-grid">
            </div>
        </div>

        <!-- Recent Logs Table -->
        <div class="logs-section">
            <h2 class="section-header">Recent Logs</h2>
            <div class="logs-table-wrapper">
                <table class="logs-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Level</th>
                            <th>Service</th>
                            <th>Message</th>
                        </tr>
                    </thead>
                    <tbody id="logs-tbody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let volumeChart = null;
        let errorChart = null;

        async function fetchData() {
            try {
                const resp = await fetch('/api/advanced-dashboard-data');
                const data = await resp.json();
                updateDashboard(data);
            } catch (err) {
                console.error('Failed to fetch dashboard data:', err);
            }
        }

        function updateDashboard(data) {
            // Update stats cards
            const summary = data.summary || {};
            document.getElementById('total-logs').textContent = (summary.total_logs || 0).toLocaleString();

            const errorRate = (summary.error_rate || 0) * 100;
            document.getElementById('error-rate').textContent = errorRate.toFixed(1) + '%';
            const errorRateCard = document.getElementById('card-error-rate');
            if (errorRate > 10) {
                errorRateCard.className = 'stat-card red';
            } else {
                errorRateCard.className = 'stat-card green';
            }

            document.getElementById('services-tracked').textContent = (summary.active_services || 0).toLocaleString();

            const alertCount = (data.active_alerts || []).length;
            document.getElementById('active-alerts').textContent = alertCount.toLocaleString();
            const alertsCard = document.getElementById('card-alerts');
            if (alertCount > 0) {
                alertsCard.className = 'stat-card red';
            } else {
                alertsCard.className = 'stat-card gray';
            }

            // Update charts
            updateCharts(data.time_series || [], data.error_trends || []);

            // Update alerts panel
            updateAlerts(data.active_alerts || []);

            // Update service health grid
            updateServiceHealth(data.service_health || []);

            // Update recent logs table
            updateRecentLogs(data.recent_logs || []);

            // Update refresh time
            document.getElementById('last-refresh').textContent = new Date().toLocaleTimeString();
        }

        function updateCharts(timeSeries, errorTrends) {
            const volumeLabels = timeSeries.map(function(b) { return b.time || ''; });
            const volumeData = timeSeries.map(function(b) { return b.total || 0; });

            const errorLabels = errorTrends.map(function(b) { return b.time || ''; });
            const errorData = errorTrends.map(function(b) { return b.error_rate || 0; });

            const chartOptions = {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    x: {
                        ticks: { color: '#888', maxTicksLimit: 8 },
                        grid: { color: '#2a2a4a' }
                    },
                    y: {
                        ticks: { color: '#888' },
                        grid: { color: '#2a2a4a' },
                        beginAtZero: true
                    }
                }
            };

            // Log Volume Chart
            if (volumeChart) {
                volumeChart.data.labels = volumeLabels;
                volumeChart.data.datasets[0].data = volumeData;
                volumeChart.update();
            } else {
                const volCtx = document.getElementById('volume-chart').getContext('2d');
                volumeChart = new Chart(volCtx, {
                    type: 'line',
                    data: {
                        labels: volumeLabels,
                        datasets: [{
                            label: 'Log Volume',
                            data: volumeData,
                            borderColor: '#4a9eff',
                            backgroundColor: 'rgba(74, 158, 255, 0.1)',
                            borderWidth: 2,
                            tension: 0.3,
                            fill: false,
                            pointRadius: 3,
                            pointBackgroundColor: '#4a9eff'
                        }]
                    },
                    options: chartOptions
                });
            }

            // Error Rate Chart
            if (errorChart) {
                errorChart.data.labels = errorLabels;
                errorChart.data.datasets[0].data = errorData;
                errorChart.update();
            } else {
                const errCtx = document.getElementById('error-chart').getContext('2d');
                errorChart = new Chart(errCtx, {
                    type: 'line',
                    data: {
                        labels: errorLabels,
                        datasets: [{
                            label: 'Error Rate (%)',
                            data: errorData,
                            borderColor: '#ff4a4a',
                            backgroundColor: 'rgba(255, 74, 74, 0.15)',
                            borderWidth: 2,
                            tension: 0.3,
                            fill: true,
                            pointRadius: 3,
                            pointBackgroundColor: '#ff4a4a'
                        }]
                    },
                    options: chartOptions
                });
            }
        }

        function updateAlerts(alerts) {
            var container = document.getElementById('alerts-container');

            if (!alerts || alerts.length === 0) {
                container.innerHTML = '<div class="no-alerts">No active alerts</div>';
                return;
            }

            var html = '';
            for (var i = 0; i < alerts.length; i++) {
                var alert = alerts[i];
                var severity = (alert.level || 'WARNING').toLowerCase();
                var cssClass = severity === 'critical' ? 'critical' : 'warning';

                html += '<div class="alert-card ' + cssClass + '">';
                html += '<div class="alert-rule">' + escapeHtml(alert.rule || 'Unknown Rule') + '</div>';
                html += '<div class="alert-message">' + escapeHtml(alert.message || '') + '</div>';
                html += '<div class="alert-meta">';
                if (alert.timestamp) {
                    html += '<span>Time: ' + escapeHtml(formatTimestamp(alert.timestamp)) + '</span>';
                }
                if (alert.service) {
                    html += '<span>Service: ' + escapeHtml(alert.service) + '</span>';
                }
                html += '</div>';
                html += '</div>';
            }

            container.innerHTML = html;
        }

        function updateServiceHealth(services) {
            var grid = document.getElementById('service-grid');
            var entries = Object.entries(services || {});

            if (entries.length === 0) {
                grid.innerHTML = '<div style="color: #888; padding: 15px;">No services detected</div>';
                return;
            }

            var html = '';
            for (var i = 0; i < entries.length; i++) {
                var name = entries[i][0];
                var svc = entries[i][1];
                var status = (svc.status || 'healthy').toLowerCase();
                var dotClass = 'healthy';
                if (status === 'warning' || status === 'degraded') {
                    dotClass = 'warning';
                } else if (status === 'down' || status === 'critical' || status === 'unhealthy') {
                    dotClass = 'down';
                }

                html += '<div class="service-card">';
                html += '<div class="service-name">';
                html += '<span class="status-dot ' + dotClass + '"></span>';
                html += escapeHtml(name);
                html += '</div>';
                html += '<div class="service-detail">Logs: ' + (svc.log_count || 0).toLocaleString() + '</div>';
                if (svc.last_seen) {
                    html += '<div class="service-detail">Last seen: ' + escapeHtml(formatTimestamp(svc.last_seen)) + '</div>';
                }
                html += '</div>';
            }

            grid.innerHTML = html;
        }

        function updateRecentLogs(logs) {
            var tbody = document.getElementById('logs-tbody');

            if (!logs || logs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#888; padding:20px;">No logs available</td></tr>';
                return;
            }

            var recentLogs = logs.slice(0, 20);
            var html = '';

            for (var i = 0; i < recentLogs.length; i++) {
                var log = recentLogs[i];
                var level = (log.level || 'INFO').toUpperCase();
                var levelClass = level.toLowerCase();

                html += '<tr>';
                html += '<td>' + escapeHtml(formatTimestamp(log.timestamp || '')) + '</td>';
                html += '<td><span class="level-badge ' + levelClass + '">' + escapeHtml(level) + '</span></td>';
                html += '<td>' + escapeHtml(log.service || '-') + '</td>';
                html += '<td class="msg-col">' + escapeHtml(log.message || '-') + '</td>';
                html += '</tr>';
            }

            tbody.innerHTML = html;
        }

        function formatTimestamp(ts) {
            if (!ts) return '-';
            try {
                var d = new Date(ts);
                if (isNaN(d.getTime())) return ts;
                return d.toLocaleTimeString();
            } catch (e) {
                return ts;
            }
        }

        function escapeHtml(str) {
            if (str === null || str === undefined) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        // Initial fetch + interval
        fetchData();
        setInterval(fetchData, 5000);
    </script>
</body>
</html>
