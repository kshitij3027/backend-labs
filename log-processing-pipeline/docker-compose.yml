services:
  generator:
    build:
      context: .
      dockerfile: generator/Dockerfile
    container_name: pipeline_generator
    volumes:
      - logs:/logs
      - ./config.yml:/app/config.yml:ro
    environment:
      - PYTHONUNBUFFERED=1
    restart: unless-stopped

  collector:
    build:
      context: .
      dockerfile: collector/Dockerfile
    container_name: pipeline_collector
    volumes:
      - logs:/logs:ro
      - collected:/data/collected
      - ./config.yml:/app/config.yml:ro
    environment:
      - PYTHONUNBUFFERED=1
    depends_on:
      - generator
    restart: unless-stopped

  parser:
    build:
      context: .
      dockerfile: parser/Dockerfile
    container_name: pipeline_parser
    volumes:
      - collected:/data/collected:ro
      - parsed:/data/parsed
      - ./config.yml:/app/config.yml:ro
    environment:
      - PYTHONUNBUFFERED=1
    depends_on:
      - collector
    restart: unless-stopped

  storage:
    build:
      context: .
      dockerfile: storage/Dockerfile
    container_name: pipeline_storage
    volumes:
      - parsed:/data/parsed:ro
      - storage:/data/storage
      - ./config.yml:/app/config.yml:ro
    environment:
      - PYTHONUNBUFFERED=1
    depends_on:
      - parser
    restart: unless-stopped

  query:
    build:
      context: .
      dockerfile: query/Dockerfile
    container_name: pipeline_query
    volumes:
      - storage:/data/storage:ro
      - ./config.yml:/app/config.yml:ro
    environment:
      - PYTHONUNBUFFERED=1
    profiles:
      - query

  web-query:
    build:
      context: .
      dockerfile: query/Dockerfile.web
    container_name: pipeline_web_query
    ports:
      - "8000:8000"
    volumes:
      - storage:/data/storage:ro
      - ./config.yml:/app/config.yml:ro
    environment:
      - PYTHONUNBUFFERED=1
    depends_on:
      - storage
    profiles:
      - web

volumes:
  logs:
  collected:
  parsed:
  storage:
